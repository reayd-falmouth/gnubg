name: Publish GNUBG Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v0.1.0)"
        required: true
      draft:
        type: boolean
        default: true
      prerelease:
        type: boolean
        default: false

  push:
    branches: [ main ]

permissions:
  contents: write
  actions: read

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Inspect downloaded artifacts
        run: |
          set -e
          ls -R artifacts

      # -------------------------
      # Create Unity zips
      # -------------------------
      - name: Create Unity bundles
        run: |
          set -e

          for PLATFORM in windows macos linux; do
            SRC="artifacts/gnubg-${PLATFORM^}"
            OUT="gnubg-${PLATFORM}.zip"

            if [ ! -d "$SRC" ]; then
              echo "Missing artifact: $SRC"
              exit 1
            fi

            rm -rf unitybundle
            mkdir -p "unitybundle/$PLATFORM"

            cp -a "$SRC/"* "unitybundle/$PLATFORM/"

            # Normalise executable name
            if [ "$PLATFORM" = "windows" ]; then
              if [ -f "unitybundle/$PLATFORM/gnubg.exe" ]; then
                mv "unitybundle/$PLATFORM/gnubg.exe" \
                   "unitybundle/$PLATFORM/gnubg-cli.exe"
              fi
            else
              if [ -f "unitybundle/$PLATFORM/gnubg" ]; then
                mv "unitybundle/$PLATFORM/gnubg" \
                   "unitybundle/$PLATFORM/gnubg-cli"
                chmod +x "unitybundle/$PLATFORM/gnubg-cli"
              fi
            fi

            (cd unitybundle && zip -r "../$OUT" .)
            rm -rf unitybundle
          done

      - name: Verify zips
        run: |
          ls -lah gnubg-*.zip

      # -------------------------
      # Publish release
      # -------------------------
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag || 'latest' }}
          name: ${{ inputs.tag || 'latest' }}
          draft: ${{ inputs.draft || false }}
          prerelease: ${{ inputs.prerelease || false }}
          generate_release_notes: true
          files: |
            gnubg-windows.zip
            gnubg-macos.zip
            gnubg-linux.zip

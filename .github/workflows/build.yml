name: Build GNUBG

on:
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: Linux
          - os: windows-latest
            artifact_name: Windows
          # Updated Intel label to avoid deprecation
          - os: macos-15-intel
            artifact_name: macOS-Intel
          # Standard Apple Silicon runner
          - os: macos-latest
            artifact_name: macOS-ARM64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # -------------------------
      # Linux dependencies
      # -------------------------
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
          autoconf automake libtool \
          make gcc g++ \
          bison flex \
          gettext gawk \
          pkg-config \
          libglib2.0-dev \
          libreadline-dev \
          python3 python3-dev

      # -------------------------
      # macOS dependencies
      # -------------------------
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install \
            autoconf automake libtool \
            bison flex gettext gawk \
            pkg-config \
            glib \
            readline \
            python \
            ncurses \
            dylibbundler

          # GNU tools first
          echo "$(brew --prefix bison)/bin" >> $GITHUB_PATH
          echo "$(brew --prefix flex)/bin" >> $GITHUB_PATH
          echo "$(brew --prefix gettext)/bin" >> $GITHUB_PATH
          echo "$(brew --prefix gawk)/bin" >> $GITHUB_PATH

          # Force GNU readline headers & libs for *configure*
          echo "CPPFLAGS=-I$(brew --prefix readline)/include" >> $GITHUB_ENV
          echo "LDFLAGS=-L$(brew --prefix readline)/lib" >> $GITHUB_ENV

      - name: Run autogen.sh
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [ -f ./autogen.sh ]; then
            ./autogen.sh
          fi

      # -------------------------
      # Configure
      # -------------------------
      - name: Configure GNUBG
        if: runner.os != 'Windows'
        shell: bash
        run: |
          ./configure

      # -------------------------
      # Build
      # -------------------------
      - name: Build
        if: runner.os != 'Windows'
        shell: bash
        run: |
          make

      # -------------------------
      # Install to staging dir
      # -------------------------
      - name: Install to staging
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p dist
          make install DESTDIR="$(pwd)/dist"
          ls -lah "$(pwd)/dist"

      # -------------------------
      # Collect artefacts
      # -------------------------
      - name: Prepare Unix artefact
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e
          mkdir -p artifact
          cp -a dist/usr/local/* artifact/
          echo "Linux artefact layout:"
          find artifact -type d

      - name: Bundle macOS Libraries and Python
        if: runner.os == 'macOS'
        run: |
          # 1. Prepare directories
          mkdir -p artifact/bin/libs
          mkdir -p artifact/lib
          
          # 2. Bundle binary dependencies (including libpython)
          # We find the Python lib directory to help dylibbundler find libpython
          PYTHON_LIB_DIR=$(python3 -c "import sysconfig; print(sysconfig.get_config_var('LIBDIR'))")
          
          dylibbundler -of -b \
            -x ./artifact/bin/gnubg \
            -x ./artifact/bin/makebearoff \
            -x ./artifact/bin/makehyper \
            -x ./artifact/bin/bearoffdump \
            -x ./artifact/bin/makeweights \
            -d ./artifact/bin/libs/ \
            -p @executable_path/libs/ \
            -s "$PYTHON_LIB_DIR" \
            -s /usr/local/lib \
            -s /opt/homebrew/lib
          
          # 3. Bundle Python Standard Library (equivalent to your Windows tar step)
          # Find the path to the standard library
          PYTHON_STD_LIB=$(python3 -c "import os; print(os.path.dirname(os.__file__))")
          PYTHON_VER=$(python3 -c "import sys; print(f'python{sys.version_info.major}.{sys.version_info.minor}')")
          
          mkdir -p "artifact/lib/$PYTHON_VER"
          
          # Copy stdlib while excluding unnecessary bloat
          rsync -av --progress "$PYTHON_STD_LIB/" "artifact/lib/$PYTHON_VER/" \
            --exclude "__pycache__" \
            --exclude "test" \
            --exclude "tests" \
            --exclude "idlelib" \
            --exclude "tkinter" \
            --exclude "*.pyc"

      # -------------------------
      # Test packaged artefact
      # -------------------------
      - name: Test packaged gnubg binary
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e

          if [ ! -d artifact/bin ]; then
            echo "ERROR: artifact/bin not found"
            exit 1
          fi

          # Resolve gnubg binary inside artefact
          GNUBG_BIN="$(find artifact/bin -type f -name 'gnubg*' -perm -111 | head -n 1)"

          if [ -z "$GNUBG_BIN" ]; then
            echo "ERROR: gnubg binary not found in artifact/bin"
            ls -lah artifact/bin
            exit 1
          fi

          echo "Running artifact smoke test: $GNUBG_BIN -t -q -h"
          "$GNUBG_BIN" -t -q -h

          echo "Packaged gnubg artifact smoke test passed"

      # -------------------------
      # Windows (Legacy MinGW build)
      # -------------------------
      # -------------------------
      # Windows (MSYS2 MinGW build)
      # -------------------------
      - name: Setup MSYS2 MinGW
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MINGW64
          install: >
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-gtk3
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-python
            mingw-w64-x86_64-libxml2
            mingw-w64-x86_64-sqlite3
            mingw-w64-x86_64-gettext
            autoconf
            automake
            libtool
            make
            pkg-config
            flex
            bison

      - name: Run autogen.sh (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          ./autogen.sh

      - name: Configure GNUBG (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          CPPFLAGS='-DAC_DATADIR="\"../share\"" -DAC_PKGDATADIR="\"../share/gnubg\""' \
          ./configure \
            --prefix="$(pwd)/dist"

      - name: Build GNUBG (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          make -j$(nproc)

      - name: Install GNUBG to staging (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          make install

      # -------------------------
      # Bundle MinGW runtime DLLs
      # -------------------------
      - name: Bundle MinGW DLLs (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          cd dist/bin
          ldd gnubg.exe | grep mingw64 | awk '{print $3}' | xargs -I{} cp {} .

      # -------------------------
      # Bundle Python runtime
      # -------------------------
      - name: Bundle macOS Libraries and Python
        if: runner.os == 'macOS'
        run: |
          # 1. Prepare directories
          mkdir -p artifact/bin/libs
          mkdir -p artifact/lib
          
          # 2. Bundle binary dependencies (including ncurses and python dylibs)
          # We add the -s flag to point dylibbundler to the Python framework's lib folder
          dylibbundler -of -b \
            -x ./artifact/bin/gnubg \
            -x ./artifact/bin/makebearoff \
            -x ./artifact/bin/makehyper \
            -x ./artifact/bin/bearoffdump \
            -x ./artifact/bin/makeweights \
            -d ./artifact/bin/libs/ \
            -p @executable_path/libs/ \
            -s /Library/Frameworks/Python.framework/Versions/3.14/lib \
            -s /opt/homebrew/lib \
            -s /usr/local/lib
          
          # 3. Bundle Python Standard Library (equivalent to your Windows logic)
          PYTHON_STD_LIB=$(python3 -c "import os; print(os.path.dirname(os.__file__))")
          PYTHON_VER=$(python3 -c "import sys; print(f'python{sys.version_info.major}.{sys.version_info.minor}')")
          
          mkdir -p "artifact/lib/$PYTHON_VER"
          
          # Use rsync -L to follow symlinks and copy actual files for portability
          rsync -avL "$PYTHON_STD_LIB/" "artifact/lib/$PYTHON_VER/" \
            --exclude "__pycache__" \
            --exclude "test" \
            --exclude "tests" \
            --exclude "*.pyc"

      # -------------------------
      # Prepare Windows artefact
      # -------------------------
      - name: Prepare Windows artefact
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          mkdir -p artifact
          cp -a dist/* artifact/
          echo "Windows artefact layout:"
          find artifact -maxdepth 2 -type d

      # -------------------------
      # Upload artefact
      # -------------------------
      - name: Upload artefact
        uses: actions/upload-artifact@v4
        with:
          name: gnubg-${{ matrix.artifact_name }}
          path: artifact

  publish_release:
    name: Publish GitHub Release
    needs: build
    # Ensure this matches your default branch (master or main)
    if: github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    permissions:
      contents: write

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Archive and Package Artifacts
        run: |
          set -e
          # Move into the artifacts directory where each matrix job created a folder
          cd artifacts
          
          # Loop through every directory (Linux, Windows, macOS-Intel, macOS-ARM64)
          for dir in */; do
            # Remove trailing slash for the zip name
            dir=${dir%/}
            echo "Archiving $dir..."
            zip -r "../$dir.zip" "$dir"
          done

      - name: Publish GitHub Release (with retry)
        uses: nick-invision/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_on: error
          command: |
            # Use a wildcard to upload all .zip files created in the previous step
            gh release create latest \
              *.zip \
              --title "GNUBG Latest Executables" \
              --notes "Automated builds for Linux, Windows, and macOS (Intel & ARM64)" 

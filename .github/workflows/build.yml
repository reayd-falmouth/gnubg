name: Build GNUBG

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # -------------------------
      # Linux dependencies
      # -------------------------
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
          autoconf automake libtool \
          make gcc g++ \
          bison flex \
          gettext gawk \
          pkg-config \
          libglib2.0-dev \
          libreadline-dev \
          python3 python3-dev


      # -------------------------
      # macOS dependencies
      # -------------------------
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install \
            autoconf automake libtool \
            bison flex gettext gawk \
            pkg-config \
            glib \
            readline \
            python

          # GNU tools first
          echo "$(brew --prefix bison)/bin" >> $GITHUB_PATH
          echo "$(brew --prefix flex)/bin" >> $GITHUB_PATH
          echo "$(brew --prefix gettext)/bin" >> $GITHUB_PATH
          echo "$(brew --prefix gawk)/bin" >> $GITHUB_PATH

          # Force GNU readline headers & libs for *configure*
          echo "CPPFLAGS=-I$(brew --prefix readline)/include" >> $GITHUB_ENV
          echo "LDFLAGS=-L$(brew --prefix readline)/lib" >> $GITHUB_ENV
            

      #      # -------------------------
      # Windows (MSYS2)
      # -------------------------
      # -------------------------
      # Windows (MSYS2 / MinGW)
      # -------------------------
      - name: Setup MSYS2
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MINGW64
          install: >
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-readline
            mingw-w64-x86_64-gettext
            mingw-w64-x86_64-python
            mingw-w64-x86_64-pkg-config
            autoconf
            automake
            libtool
            bison
            flex
            gawk

      # -------------------------
      # Autogen (if needed)
      # -------------------------
      - name: Run autogen.sh (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          ./autogen.sh

      - name: Run autogen.sh
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [ -f ./autogen.sh ]; then
            ./autogen.sh
          fi

      # -------------------------
      # Configure
      # -------------------------
      - name: Configure GNUBG
        if: runner.os != 'Windows'
        shell: bash
        run: |
          ./configure

      - name: Configure GNUBG (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          ./configure      

      # -------------------------
      # Build
      # -------------------------
      - name: Build
        if: runner.os != 'Windows'
        shell: bash
        run: |
          make

      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          make

      # -------------------------
      # Install to staging dir
      # -------------------------
      - name: Install to staging
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p dist
          make install DESTDIR="$(pwd)/dist"
          ls -lah "$(pwd)/dist/**"

      - name: Install to staging (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          mkdir -p dist
          make install DESTDIR="$(pwd)/dist"
          ls -lah "$(pwd)/dist/**"

      # -------------------------
      # Collect artefacts
      # -------------------------
      - name: Collect binaries
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p artifact/bin
          
          find dist -type f -name "gnubg*" -exec cp {} artifact/bin/ \;
          find . -type f -name "libgnubg.py" -exec cp {} artifact/bin/ \; || true
          
          ls -lah artifact/bin

      - name: Collect Windows artefact (classic GNUBG layout)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -e

          mkdir -p artifact/windows

          # 1. Copy executables
          find dist -type f -iname "*.exe" -exec cp {} artifact/windows/ \;

          # 3. Explode share/gnubg into root
          if [ -d dist/mingw64/share/gnubg ]; then
            cp -r dist/mingw64/share/gnubg/* artifact/windows/
          else
            echo "ERROR: dist/mingw64/share/gnubg not found"
            find dist -maxdepth 3 -type d
            exit 1
          fi

          # 4. Provide gnubg-cli.exe (Windows convention)
          if [ -f artifact/windows/gnubg.exe ]; then
            cp artifact/windows/gnubg.exe artifact/windows/gnubg-cli.exe
          fi

          echo "Final Windows layout:"
          ls -lah artifact/windows      

      - name: Bundle Windows DLL dependencies
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -e

          EXE="artifact/windows/gnubg.exe"

          if [ ! -f "$EXE" ]; then
            echo "ERROR: gnubg.exe not found in artifact/windows"
            exit 1
          fi

          echo "Resolving DLL dependencies for gnubg.exe"

          ldd "$EXE" \
            | grep mingw64 \
            | awk '{print $3}' \
            | while read -r dll; do
                if [ -f "$dll" ]; then
                  cp -u "$dll" artifact/windows/
                fi
              done

          echo "Bundled DLLs:"
          ls -lah artifact/windows/*.dll

      # -------------------------
      # Test packaged artefact
      # -------------------------
      - name: Test packaged gnubg binary
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e

          if [ ! -d artifact/bin ]; then
            echo "ERROR: artifact/bin not found"
            exit 1
          fi

          # Resolve gnubg binary inside artefact
          GNUBG_BIN="$(find artifact/bin -type f -name 'gnubg*' -perm -111 | head -n 1)"

          if [ -z "$GNUBG_BIN" ]; then
            echo "ERROR: gnubg binary not found in artifact/bin"
            ls -lah artifact/bin
            exit 1
          fi

          echo "Running artifact smoke test: $GNUBG_BIN -t -q -h"
          "$GNUBG_BIN" -t -q -h

          echo "Packaged gnubg artifact smoke test passed"

      - name: Test Windows packaged artefact
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -e

          if [ ! -f artifact/windows/gnubg.exe ]; then
            echo "ERROR: gnubg.exe not found"
            exit 1
          fi

          echo "Running Windows smoke test"
          artifact/windows/gnubg.exe -t -q -h > /dev/null

          echo "Windows gnubg smoke test passed"

      # -------------------------
      # Upload artefact
      # -------------------------
      - name: Upload artefact
        uses: actions/upload-artifact@v4
        with:
          name: gnubg-${{ runner.os }}
          path: artifact
